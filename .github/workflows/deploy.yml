name: Build and Deploy to GKE

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build common package
      run: npm run build:common

    - name: Run tests
      run: npm run test --if-present

    # Authenticate with Google Cloud
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker

    # Build and push backend image
    - name: Build Backend Docker image
      run: |
        docker build -f Dockerfile.backend -t gcr.io/$GCP_PROJECT_ID/backend:$GITHUB_SHA -t gcr.io/$GCP_PROJECT_ID/backend:latest .

    - name: Push Backend Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/backend:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/backend:latest

    # Build and push frontend image
    - name: Build Frontend Docker image
      run: |
        docker build -f Dockerfile.frontend -t gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA -t gcr.io/$GCP_PROJECT_ID/frontend:latest .

    - name: Push Frontend Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/frontend:latest

    # Get GKE credentials
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $GCP_PROJECT_ID

    # Create or update Kubernetes secrets
    - name: Create Kubernetes secrets
      run: |
        kubectl create secret generic app-secrets \
          --from-literal=supabase-url=$SUPABASE_URL \
          --from-literal=supabase-key=$SUPABASE_KEY \
          --dry-run=client -o yaml | kubectl apply -f -

    # Deploy to GKE
    - name: Deploy Backend to GKE
      run: |
        sed -i "s|gcr.io/PROJECT_ID/backend:TAG|gcr.io/$GCP_PROJECT_ID/backend:$GITHUB_SHA|g" k8s/backend-deployment.yaml
        kubectl apply -f k8s/backend-deployment.yaml
        kubectl apply -f k8s/backend-service.yaml
        kubectl rollout status deployment/backend

    - name: Deploy Frontend to GKE
      run: |
        sed -i "s|gcr.io/PROJECT_ID/frontend:TAG|gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA|g" k8s/frontend-deployment.yaml
        kubectl apply -f k8s/frontend-deployment.yaml
        kubectl apply -f k8s/frontend-service.yaml
        kubectl rollout status deployment/frontend

    - name: Get Service URLs
      run: |
        echo "Backend URL:"
        kubectl get service backend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
        echo ""
        echo "Frontend URL:"
        kubectl get service frontend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
