name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '**.md'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER || 'noclue-cluster' }}
  GKE_ZONE: ${{ secrets.GKE_ZONE || 'us-central1-a' }}
  NAMESPACE: 'noclue-app'

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build common package
      run: npm run build:common

    - name: Run tests
      run: npm run test --if-present

    # Authenticate with Google Cloud
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker

    # Build and push Frontend
    - name: Build Frontend Docker image
      run: |
        docker build -f Dockerfile.frontend \
          -t gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/frontend:latest .

    - name: Push Frontend Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/frontend:latest

    # Build and push User Service
    - name: Build User Service Docker image
      run: |
        docker build -f Dockerfile.user-service \
          -t gcr.io/$GCP_PROJECT_ID/user-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/user-service:latest .

    - name: Push User Service Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/user-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/user-service:latest

    # Build and push Question Service
    - name: Build Question Service Docker image
      run: |
        docker build -f Dockerfile.question-service \
          -t gcr.io/$GCP_PROJECT_ID/question-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/question-service:latest .

    - name: Push Question Service Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/question-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/question-service:latest

    # Build and push Matching Service
    - name: Build Matching Service Docker image
      run: |
        docker build -f Dockerfile.matching-service \
          -t gcr.io/$GCP_PROJECT_ID/matching-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/matching-service:latest .

    - name: Push Matching Service Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/matching-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/matching-service:latest

    # Build and push Collaboration Service
    - name: Build Collaboration Service Docker image
      run: |
        docker build -f Dockerfile.collaboration-service \
          -t gcr.io/$GCP_PROJECT_ID/collaboration-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/collaboration-service:latest .

    - name: Push Collaboration Service Docker image
      run: |
        docker push gcr.io/$GCP_PROJECT_ID/collaboration-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/collaboration-service:latest

    # Get GKE credentials
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $GCP_PROJECT_ID

    # NOTE: Secrets are managed by Terraform in the noclue-app namespace
    # If you need to update secrets, use Terraform or kubectl directly

    # Deploy Frontend to GKE
    - name: Deploy Frontend to GKE
      run: |
        sed -i "s|gcr.io/PROJECT_ID/frontend:TAG|gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA|g" k8s/frontend-deployment.yaml
        sed -i "s|namespace: default|namespace: $NAMESPACE|g" k8s/frontend-deployment.yaml
        kubectl apply -f k8s/frontend-deployment.yaml -n $NAMESPACE
        kubectl apply -f k8s/frontend-service.yaml -n $NAMESPACE
        kubectl rollout status deployment/frontend -n $NAMESPACE

    # Deploy User Service to GKE
    - name: Deploy User Service to GKE
      run: |
        kubectl set image deployment/user-service \
          user-service=gcr.io/$GCP_PROJECT_ID/user-service:$GITHUB_SHA \
          -n $NAMESPACE
        kubectl rollout status deployment/user-service -n $NAMESPACE

    # Deploy Question Service to GKE
    - name: Deploy Question Service to GKE
      run: |
        kubectl set image deployment/question-service \
          question-service=gcr.io/$GCP_PROJECT_ID/question-service:$GITHUB_SHA \
          -n $NAMESPACE
        kubectl rollout status deployment/question-service -n $NAMESPACE

    # Deploy Matching Service to GKE
    - name: Deploy Matching Service to GKE
      run: |
        kubectl set image deployment/matching-service \
          matching-service=gcr.io/$GCP_PROJECT_ID/matching-service:$GITHUB_SHA \
          -n $NAMESPACE
        kubectl rollout status deployment/matching-service -n $NAMESPACE

    # Deploy Collaboration Service to GKE
    - name: Deploy Collaboration Service to GKE
      run: |
        kubectl set image deployment/collaboration-service \
          collaboration-service=gcr.io/$GCP_PROJECT_ID/collaboration-service:$GITHUB_SHA \
          -n $NAMESPACE
        kubectl rollout status deployment/collaboration-service -n $NAMESPACE

    - name: Get Service URLs
      run: |
        echo "=== Service URLs ==="
        echo ""
        echo "Frontend:"
        kubectl get service frontend-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
        echo ""
        echo ""
        echo "User Service:"
        kubectl get service user-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
        echo ""
        echo ""
        echo "Question Service:"
        kubectl get service question-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
        echo ""
        echo ""
        echo "Matching Service:"
        kubectl get service matching-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
        echo ""
        echo ""
        echo "Collaboration Service:"
        kubectl get service collaboration-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
        echo ""
