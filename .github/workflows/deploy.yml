name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: noclue-cluster
  GKE_ZONE: us-central1-a
  NAMESPACE: noclue-app

jobs:
  deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build common package
      run: npm run build:common

    - name: Run tests
      run: npm run test --if-present

    # Authenticate with Google Cloud
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    # Build and push Docker images
    - name: Build and Push Frontend
      run: |
        docker build -f Dockerfile.frontend \
          -t gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/frontend:latest .
        docker push gcr.io/$GCP_PROJECT_ID/frontend:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/frontend:latest

    - name: Build and Push User Service
      run: |
        docker build -f Dockerfile.user-service \
          -t gcr.io/$GCP_PROJECT_ID/user-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/user-service:latest .
        docker push gcr.io/$GCP_PROJECT_ID/user-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/user-service:latest

    - name: Build and Push Question Service
      run: |
        docker build -f Dockerfile.question-service \
          -t gcr.io/$GCP_PROJECT_ID/question-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/question-service:latest .
        docker push gcr.io/$GCP_PROJECT_ID/question-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/question-service:latest

    - name: Build and Push Matching Service
      run: |
        docker build -f Dockerfile.matching-service \
          -t gcr.io/$GCP_PROJECT_ID/matching-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/matching-service:latest .
        docker push gcr.io/$GCP_PROJECT_ID/matching-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/matching-service:latest

    - name: Build and Push Collaboration Service
      run: |
        docker build -f Dockerfile.collaboration-service \
          -t gcr.io/$GCP_PROJECT_ID/collaboration-service:$GITHUB_SHA \
          -t gcr.io/$GCP_PROJECT_ID/collaboration-service:latest .
        docker push gcr.io/$GCP_PROJECT_ID/collaboration-service:$GITHUB_SHA
        docker push gcr.io/$GCP_PROJECT_ID/collaboration-service:latest

    # Get GKE credentials
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER \
          --zone $GKE_ZONE \
          --project $GCP_PROJECT_ID

    # Install kubectl auth plugin
    - name: Install gke-gcloud-auth-plugin
      run: |
        gcloud components install gke-gcloud-auth-plugin

    # Setup cluster (idempotent - safe to run every time)
    - name: Setup GKE Cluster
      run: |
        chmod +x ./scripts/setup-gke.sh
        ./scripts/setup-gke.sh

    # Deploy services with secrets from GitHub Secrets
    - name: Deploy Services
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
        SUPABASE_PUBLISHABLE_KEY: ${{ secrets.SUPABASE_PUBLISHABLE_KEY }}
      run: |
        chmod +x ./scripts/deploy-services.sh
        ./scripts/deploy-services.sh

    # Get service URLs
    - name: Get Service URLs
      run: |
        echo "=== Service URLs ==="
        echo ""
        echo "Frontend (LoadBalancer):"
        kubectl get service frontend-service -n $NAMESPACE \
          -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "Pending..."
        echo ""
        echo ""
        echo "Backend Services (ClusterIP - internal only):"
        kubectl get services -n $NAMESPACE -l service=backend || true
        echo ""
        echo "=== Deployment Complete ==="
