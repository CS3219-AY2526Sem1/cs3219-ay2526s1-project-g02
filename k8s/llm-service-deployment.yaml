apiVersion: apps/v1
kind: Deployment
metadata:
  name: llm-service
  namespace: noclue-app
  labels:
    app: llm-service
    service: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: llm-service
  template:
    metadata:
      labels:
        app: llm-service
    spec:
      containers:
        - name: llm-service
          image: gcr.io/noclue-476404/llm-service:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 4005
              name: http
              protocol: TCP
          envFrom:
          - secretRef:
              name: supabase-secrets
          - configMapRef:
              name: pubsub-config
          env:
            - name: PORT
              value: "4005"
            - name: NODE_ENV
              value: "production"
            - name: LLM_PROVIDER
              value: "vertex"
            - name: GCP_PROJECT_ID
              valueFrom:
                configMapKeyRef:
                  name: pubsub-config
                  key: GCP_PROJECT_ID
            - name: GCP_LOCATION
              value: "us-central1"
            - name: GCP_KEY_FILENAME
              value: "/etc/gcp/key.json"
            - name: SUPABASE_KEY
              valueFrom:
                secretKeyRef:
                  name: supabase-secrets
                  key: SUPABASE_SECRET_KEY
            - name: USER_SERVICE_URL
              value: "http://user-service.noclue-app.svc.cluster.local:4001"
            - name: QUESTION_SERVICE_URL
              value: "http://question-service.noclue-app.svc.cluster.local:4002"
            - name: MATCHING_SERVICE_URL
              value: "http://matching-service.noclue-app.svc.cluster.local:4003"
            - name: COLLABORATION_SERVICE_URL
              value: "http://collaboration-service.noclue-app.svc.cluster.local:4004"
            - name: CORS_ORIGIN
              value: "https://noclue.com"
          volumeMounts:
          - name: gcp-key
            mountPath: /etc/gcp
            readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 4005
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 4005
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
      volumes:
      - name: gcp-key
        secret:
          secretName: pubsub-key

